# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information, see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-maven

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Java CI with Maven

on:
  push:
    branches:
      - main
      - 'release/**'
    tags:
      - 'v*.*.*'
    paths:
      - 'src/**'                                                                                                                                                                                                                                                                                                                                                                                                                    │
      - 'pom.xml'

  pull_request:
    branches:
      - main
      - 'release/**'
    paths:
      - 'src/**'                                                                                                                                                                                                                                                                                                                                                                                                                    │
      - 'pom.xml'

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  check-paths:
    runs-on: ubuntu-latest
    outputs:
      notion_changed: ${{ steps.filter.outputs.notion_changed }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            notion_changed:
              - 'src/main/java/com/github/javydreamercsw/management/service/sync/**'

  build-and-unit-test:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Apply code formatting
      run: mvn spotless:apply

    - name: Run unit tests with coverage
      run: mvn -B verify -Pcoverage

    - name: Upload unit test coverage data
      uses: actions/upload-artifact@v4
      with:
        name: jacoco-exec
        path: target/jacoco.exec

  integration-tests:
    runs-on: ubuntu-latest
    needs: build-and-unit-test
    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Run Integration Tests
      run: mvn -B verify -Pintegration-test

    - name: Upload integration test coverage data
      uses: actions/upload-artifact@v4
      with:
        name: jacoco-it-exec
        path: target/jacoco-it.exec

  notion-integration-tests:
    runs-on: ubuntu-latest
    needs: [build-and-unit-test, check-paths]
    if: needs.check-paths.outputs.notion_changed == 'true'
    env:
      NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Run Notion Integration Tests
      run: mvn -B verify -Pnotion-integration-test

    - name: Upload notion integration test coverage data
      uses: actions/upload-artifact@v4
      with:
        name: jacoco-notion-it-exec
        path: target/jacoco-notion-it.exec

  e2e-tests:
    runs-on: ubuntu-latest
    needs: build-and-unit-test
    env:
      HEADLESS: 'true'
      GITHUB_ACTIONS: 'true'
    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    - name: Set up Chrome
      uses: browser-actions/setup-chrome@v1
    - name: Run E2E Tests
      run: mvn -B verify -Pe2e
    - name: Upload E2E test coverage data
      uses: actions/upload-artifact@v4
      with:
        name: jacoco-e2e-exec
        path: target/jacoco-e2e.exec
  
  notion-e2e-tests:
    runs-on: ubuntu-latest
    needs: [build-and-unit-test, check-paths]
    if: needs.check-paths.outputs.notion_changed == 'true'
    env:
      HEADLESS: 'true'
      GITHUB_ACTIONS: 'true'
      NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    - name: Set up Chrome
      uses: browser-actions/setup-chrome@v1
    - name: Run Notion E2E Tests
      run: mvn -B verify -Pnotion-e2e-test
    - name: Upload Notion E2E test coverage data
      uses: actions/upload-artifact@v4
      with:
        name: jacoco-notion-e2e-exec
        path: target/jacoco-notion-e2e.exec

  coverage-and-analysis:
    runs-on: ubuntu-latest
    needs: [build-and-unit-test, integration-tests, e2e-tests, notion-integration-tests, notion-e2e-tests]
    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Download unit test coverage data
      uses: actions/download-artifact@v4
      with:
        name: jacoco-exec
        path: target/

    - name: Download integration test coverage data
      uses: actions/download-artifact@v4
      with:
        name: jacoco-it-exec
        path: target/

    - name: Download E2E test coverage data
      uses: actions/download-artifact@v4
      with:
        name: jacoco-e2e-exec
        path: target/

    - name: Download Notion integration test coverage data
      uses: actions/download-artifact@v4
      with:
        name: jacoco-notion-it-exec
        path: target/

    - name: Download Notion E2E test coverage data
      uses: actions/download-artifact@v4
      with:
        name: jacoco-notion-e2e-exec
        path: target/

    - name: Ensure classes are compiled
      run: mvn -B compile -Pcoverage

    - name: Merge coverage data
      run: mvn -B jacoco:merge -Pcoverage

    - name: Generate merged coverage report
      run: mvn -B jacoco:report -Pcoverage -Djacoco.dataFile=target/jacoco-merged.exec -Djacoco.outputDirectory=target/site/jacoco-merged

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v5
      with:
        file: ./target/site/jacoco-merged/jacoco.xml
        flags: merged
        name: codecov-umbrella
        fail_ci_if_error: true
        token: ${{ secrets.CODECOV_TOKEN }}

  # Build and push Docker image (no release profile) on release/* branches
  docker-image-release-branch:
    if: startsWith(github.ref, 'refs/heads/release/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push Docker image (no release profile)
        run: mvn clean package jib:build -Pproduction -DskipTests=true

  # Build and push Docker image with release profile on version tag
  docker-image-main-release:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push Docker image (release profile)
        run: mvn clean package jib:build -Prelease,production -DskipTests=true

  docker-it:
    runs-on: ubuntu-latest
    needs: e2e-tests
    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    - name: Run Docker Integration Tests
      run: mvn -B verify -Pdocker-it
